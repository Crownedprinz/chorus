<?xml version="1.0" encoding="UTF-8"?>
<!-- These variables define the Windows Installer product version, product code and upgrade code. They   -->
<!-- will be used later on in this file.                                                                 -->
<?define Property_ProductVersion = ".*" ?>
<!-- Generate a new one for each installer, since it only uses the major upgrade approach for msi installers.
cf: http://wix.sourceforge.net/manual-wix3/major_upgrade.htm
and http://www.joyofsetup.com/2010/01/16/major-upgrades-now-easier-than-ever/
for details on why going the major upgrade route is the right answer for an msi-only install system is right.
-->
<?define Property_ProductCode = "*" ?>
<!--Don't even think of EVER changing the Property_UpgradeCode. -->
<?define Property_UpgradeCode = "C1EE5823-E382-11DE-8A39-0800200C9A66" ?>
<!-- good intro to the component vs. file thing, and why each file here is a separate component:
http://blogs.msdn.com/robmen/archive/2003/10/04/56479.aspx -->

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension">

  <Product Id="$(var.Property_ProductCode)" Name="Chorus Hub $(var.Property_ProductVersion)" Language="1033" Version="$(var.Property_ProductVersion)" Manufacturer="SIL" UpgradeCode="$(var.Property_UpgradeCode)">

	<!-- autogenerated package id -->
	<Package Id="*" Compressed="yes" InstallerVersion="200" InstallScope="perMachine" />

	<UIRef Id="WixUI_Minimal"/>

	<!--  -->
	<MajorUpgrade AllowDowngrades="no" DowngradeErrorMessage="A newer version of Chorus Hub is already installed. Setup will now exit." Schedule="afterInstallValidate"/>

	<PropertyRef Id="NETFRAMEWORK40CLIENT"/>
	<Condition Message="Before [ProductName] can install, you need to install Microsoft's free .NET Framework 4 (Client).">
	  <![CDATA[Installed OR NETFRAMEWORK40CLIENT]]>
	</Condition>

	<!--because of bug, this needs to be 1 (now set with "'InstallScope="perMachine"' in Package element, above.
	<Property Id="ALLUSERS">1</Property> -->

	<Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

	<Directory Id="TARGETDIR" Name="SourceDir">
		<Directory Id="ProgramFilesFolder" Name="PFiles">
			<Directory Id="SILDIR" Name="SIL">
				<Directory Id="INSTALLDIR" Name="Chorus Hub">
					<Directory Id="mercurial" Name="mercurial">
						<Component Id="mercurial.ini" Guid="FA715224-9B87-44a4-B6D3-18EC40712266">
							<File Id="mercurial.ini" Name="mercurial.ini" Source="..\..\mercurial\mercurial.ini" />
							<IniFile Id="mercurial.ini_extension_fixutf8"
								Action="addLine"
								Directory="mercurial"
								Section="extensions"
								Name="mercurial.ini"
								Key="fixutf8"
								Value="[#fixutf8.py]" />
						</Component>
						<!-- This will be filled in by the generated fragment GeneratedMercurial.wxs -->
					</Directory>
					<Directory Id="MercurialExtensions" Name="MercurialExtensions">
						<!-- This will be filled in by the generated fragment GeneratedMercurialExtensions.wxs -->
					</Directory>

					<!-- Main assemblies -->
					<Component Id="ChorusHub.exe" Guid="C1EE5824-E382-11DE-8A39-0800200C9A66">
						<File Id="ChorusHub.exe" Name="ChorusHub.exe" Source="..\..\output\Release\ChorusHub.exe" />
						<Registry Root="HKCU" Key="Software\[Manufacturer]\Chorus Hub\Components\CorusHub.exe" KeyPath="yes" />
						<Shortcut Id="startMenuShortcut"  Directory="ChorusHubShortcutDir" Name="Chorus Hub"
							WorkingDirectory="ProgramDir" Target="[!ChorusHub.exe]"  Icon ="chorusHubIcon.ico" />
						<fire:FirewallException Id="ChorusHubFireWallException" Name="Chorus Hub Server" Program="[#ChorusHub.exe]" Scope="localSubnet" IgnoreFailure="yes"/>
						<!-- TODO: is there a way we could also add the needed exception for the client here in the merge module? -->
						<!--<fire:FirewallException Id="ChorusHubFireWallException" Name="Chorus Hub Send/Receive Client" Program="[#ChorusHub.exe]" Scope="localSubnet" IgnoreFailure="yes"/> -->
					</Component>
					<Component Id="RegInstallationDir" Guid="C1EECD4D-E382-11DE-8A39-0800200C9A66">
						<RegistryKey Id="keyChorusHub.exe" Action="createAndRemoveOnUninstall" Root="HKLM" Key="SOFTWARE\[Manufacturer]\Chorus Hub">
							<RegistryValue Id="ChorusHubInstallationDir" Type="string" Value="[INSTALLDIR]" Name="InstallationDir"/>
						</RegistryKey>
					</Component>
					<Component Id="ChorusHub.exe.config" Guid="C1EECD41-E382-11DE-8A39-0800200C9A66">
						<File Id="ChorusHub.exe.config" Name="ChorusHub.exe.config" KeyPath="yes" Source="..\..\output\Release\ChorusHub.exe.config"/>
					</Component>
					<Component Id="LibChorus.dll" Guid="C1EE5827-E382-11DE-8A39-0800200C9A66">
						<File Id="LibChorus.dll" Name="LibChorus.dll" KeyPath="yes" Source="..\..\output\Release\LibChorus.dll" />
					</Component>

					<!-- used by chorus -->
					<Component Id="Autofac.dll" Guid="C1EECD43-E382-11DE-8A39-0800200C9A66">
						<File Id="Autofac.dll" Name="Autofac.dll" KeyPath="yes" Source="..\..\output\Release\Autofac.dll" />
					</Component>
					<Component Id="chorushelp.chm" Guid="C1EE5825-E382-11DE-8A39-0800200C9A66">
						<File Id="chorushelp.chm" Name="Chorus_Help.chm" KeyPath="yes" Source="..\..\lib\Chorus_Help.chm"/>
					</Component>
					<!-- used by chorus help -->
					<Component Id="Vulcan.Uczniowie.HelpProvider.dll" Guid="C1EECD42-E382-11DE-8A39-0800200C9A66">
						<File Id="Vulcan.Uczniowie.HelpProvider.dll" Name="Vulcan.Uczniowie.HelpProvider.dll" KeyPath="yes" Source="..\..\output\Release\Vulcan.Uczniowie.HelpProvider.dll" />
					</Component>

					<Component Id="Palaso.dll" Guid="C1EE5828-E382-11DE-8A39-0800200C9A66">
						<File Id="Palaso.dll" Name="Palaso.dll" KeyPath="yes" Source="..\..\output\Release\Palaso.dll" />
					</Component>
					<Component Id="PalasoUIWindowsForms.dll" Guid="C1EE582A-E382-11DE-8A39-0800200C9A66">
						<File Id="PalasoUIWindowsForms.dll" Name="PalasoUIWindowsForms.dll" KeyPath="yes" Source="..\..\output\Release\PalasoUIWindowsForms.dll" />
					</Component>
					<Component Id="Palaso.Lift.dll" Guid="C1EECD44-E382-11DE-8A39-0800200C9A66">
						<File Id="Palaso.Lift.dll" Name="Palaso.Lift.dll" KeyPath="yes" Source="..\..\output\Release\Palaso.Lift.dll" />
					</Component>

					<!-- ICU assemblies used by chorus/palaso -->
					<Component Id="icu.net.dll" Guid="C1EECD46-E382-11DE-8A39-0800200C9A66">
						<File Id="icu.net.dll" Name="icu.net.dll" KeyPath="yes" Source="..\..\output\release\icu.net.dll" />
					</Component>
					<Component Id="icudt40.dll" Guid="C1EECD47-E382-11DE-8A39-0800200C9A66">
						<File Id="icudt40.dll" Name="icudt40.dll" KeyPath="yes" Source="..\..\lib\Release\icudt40.dll" />
					</Component>
					<Component Id="icuin40.dll" Guid="C1EECD48-E382-11DE-8A39-0800200C9A66">
						<File Id="icuin40.dll" Name="icuin40.dll" KeyPath="yes" Source="..\..\lib\Release\icuin40.dll" />
					</Component>
					<Component Id="icuuc40.dll" Guid="C1EECD49-E382-11DE-8A39-0800200C9A66">
						<File Id="icuuc40.dll" Name="icuuc40.dll" KeyPath="yes" Source="..\..\lib\Release\icuuc40.dll" />
					</Component>

					<!-- L10NSharp assembly used by chorus/palaso -->
					<Component Id="L10NSharp.dll" Guid="C1EECD4A-E382-11DE-8A39-0800200C9A66">
						<File Id="L10NSharp.dll" Name="L10NSharp.dll" KeyPath="yes" Source="..\..\lib\common\L10NSharp.dll"/>
					</Component>
				</Directory>
			</Directory>
		</Directory>

		<Directory Id="ProgramMenuFolder" Name="Programs">
			<Directory Id="ChorusHubShortcutDir" Name="Chorus Hub">
				<Component Id="removeShortcutDir" Guid="C1EECD40-E382-11DE-8A39-0800200C9A66">
					<RemoveFolder Id="shortcutDirRemover" On="uninstall"/>
					<RegistryKey Id="keyPathForRemoveShortcutDir" Action ="createAndRemoveOnUninstall" Root="HKCU" Key="Software\[Manufacturer]\Chorus Hub\Components\ChorusHubShortcutDir">
						<RegistryValue Type ="string" Value =""  Action ="write" KeyPath ="yes"/>
					</RegistryKey>
				</Component>
			</Directory>
		</Directory>

		<!--<Directory Id="SystemFolder" Name="System32">
			<Merge Id="CRT90" Language="1033" SourceFile="..\..\lib\Microsoft_VC90_CRT_x86.msm" DiskId="1"/>
			<Merge Id="CRT90Policy" Language="1033" SourceFile="..\..\lib\policy_9_0_Microsoft_VC90_CRT_x86.msm" DiskId="1"/>
		</Directory>-->
	</Directory>

	<Feature Id="ProductFeature" Level="1" Title="Basic Stuff">
		<ComponentRef Id="ChorusHub.exe"/>
		<ComponentRef Id="ChorusHub.exe.config"/>
		<ComponentRef Id="LibChorus.dll"/>
		<ComponentRef Id="Autofac.dll"/>
		<ComponentRef Id="chorushelp.chm"/>
		<ComponentGroupRef Id="Mercurial"/>
		<ComponentGroupRef Id="MercurialExtensions"/>
		<ComponentRef Id="mercurial.ini"/>
		<ComponentRef Id="Vulcan.Uczniowie.HelpProvider.dll"/>

		<ComponentRef Id="Palaso.dll"/>
		<ComponentRef Id="Palaso.Lift.dll"/>
		<ComponentRef Id="PalasoUIWindowsForms.dll"/>

		<ComponentRef Id="icu.net.dll"/>
		<ComponentRef Id="icudt40.dll"/>
		<ComponentRef Id="icuin40.dll"/>
		<ComponentRef Id="icuuc40.dll"/>

		<ComponentRef Id="L10NSharp.dll"/>

		<ComponentRef Id="removeShortcutDir"/>
		<ComponentRef Id="RegInstallationDir"/>
		<!--<MergeRef Id="CRT90"/>
		<MergeRef Id="CRT90Policy"/>-->
	</Feature>

	<Icon Id="chorusHubIcon.ico" SourceFile="..\..\output\Release\ChorusHub.exe"/>
	<!-- what you see in add/remove programs control panel -->
	<Property Id="ARPPRODUCTICON" Value="chorusHubIcon.ico"/>
  </Product>

</Wix>
